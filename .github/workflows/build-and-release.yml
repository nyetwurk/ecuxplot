name: Build and Release

on:
  schedule:
    # Run every night at 2 AM PST (10 AM UTC)
    - cron: '0 10 * * *'
  workflow_dispatch: # Allow manual triggering
  push:
    branches: [ '*' ]

permissions:
  contents: write
  packages: write
  actions: read

env:
  BUILD_CACHE_KEY: latest-build-cache

jobs:
  build-all-platforms:
    uses: ./.github/workflows/build-matrix.yml
    with:
      use-cache: true
    secrets: inherit

  notify:
    needs: [build-all-platforms]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Notify on success
        if: needs.build-all-platforms.result == 'success'
        run: |
          echo "✅ Build completed successfully"
          echo "Artifacts created for macOS, Windows, and Linux"

      - name: Notify on failure
        if: needs.build-all-platforms.result == 'failure'
        run: |
          echo "❌ Build failed"
          exit 1

  create-latest-release:
    needs: [build-all-platforms]
    if: needs.build-all-platforms.result == 'success' && (github.event_name == 'schedule' || github.event_name == 'workflow_dispatch')
    uses: ./.github/workflows/create-release.yml
    with:
      # Only here to ensure order of releases is correct in the UI
      # Side benefit is that we can tell the last time this jobs was triggered and ran successfully
      tag-name: latest
      release-name: ECUxPlot latest build
      is-prerelease: true
      is-latest: true
      release-body: |
        Latest build from commit ${{ github.sha }}

        **Downloads:**
        - **Windows**: ECUxPlot-latest-setup.exe
        - **macOS**: ECUxPlot-latest.dmg, ECUxPlot-latest-MacOS.zip
        - **Linux**: ECUxPlot-latest.tar.gz
        - **Portable**: ECUxPlot-latest.jar, ECUxPlot.jar, mapdump.jar

        Built on: ${{ github.run_number }}
    secrets: inherit
