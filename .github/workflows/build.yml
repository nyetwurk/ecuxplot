---
name: Build ECUxPlot Multi-Platform

on:
  push:
    branches: [ master, main ]

jobs:
  build-macos:
    runs-on: macos-latest
    steps:
    - uses: actions/checkout@v5
      with:
        fetch-depth: 0

    - name: Set up JDK 18
      uses: actions/setup-java@v5
      with:
        java-version: '18'
        distribution: 'temurin'

    - name: Install Make
      run: |
        brew install make
        echo "/opt/homebrew/bin" >> $GITHUB_PATH

    - name: Build macOS targets
      run: |
        make all
      env:
        DISPLAY: ""

    - name: Upload macOS artifacts
      uses: actions/upload-artifact@v4
      with:
        name: macos-builds
        path: |
          ECUxPlot-*.jar
          mapdump.jar

  build-linux:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v5
      with:
        fetch-depth: 0

    - name: Set up JDK 18
      uses: actions/setup-java@v5
      with:
        java-version: '18'
        distribution: 'temurin'

    - name: Install build tools
      run: |
        sudo apt-get update
        sudo apt-get install -y make ant nsis mingw-w64 binutils-mingw-w64
        # Install Launch4j manually (not available in Ubuntu repos)
        # Version managed by Renovate via .github/dependabot-config/launch4j-version.txt
        LAUNCH4J_VERSION=$(cat .github/dependabot-config/launch4j-version.txt | grep -v '^#' | head -1)
        wget -O /tmp/launch4j.tar.gz "https://sourceforge.net/projects/launch4j/files/launch4j-3/3.14/${LAUNCH4J_VERSION}-linux-x64.tgz/download"
        tar -xzf /tmp/launch4j.tar.gz -C /tmp
        sudo mv /tmp/launch4j /opt/launch4j

    - name: Build Linux/Windows targets
      run: |
        export PATH="/opt/launch4j:$PATH"
        make exes

    - name: Upload Linux/Windows artifacts
      uses: actions/upload-artifact@v4
      with:
        name: linux-windows-builds
        path: |
          build/CYGWIN_NT/*.exe
          ECUxPlot-*.jar
          mapdump.jar

