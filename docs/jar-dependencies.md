# JAR Dependencies Management

This document describes the process for adding new JAR libraries to the ECUxPlot project. Currently, adding JAR dependencies requires manual changes to multiple files, making it error-prone and time-consuming.

**Related Issue**: [Make adding jar libraries easier, automate where possible #61](https://github.com/nyetwurk/ecuxplot/issues/61)

## Current JAR Dependency System

ECUxPlot uses a two-tier JAR dependency system:

### ECUxPlot JARs

Core application dependencies that are included in the main application JAR's classpath:

- `jcommon-*.jar` - JFreeChart common utilities
- `jfreechart-*.jar` - Charting library
- `jspline.jar` - Spline interpolation
- `flanagan.jar` - Mathematical utilities
- `slf4j-api-*.jar` - Logging API
- `logback-classic-*.jar` - Logging implementation
- `logback-core-*.jar` - Logging core

### Common JARs

Shared dependencies used by both main application and utilities:

- `opencsv-*.jar` - CSV parsing
- `commons-cli-*.jar` - Command line interface
- `commons-lang3-*.jar` - Apache Commons utilities (required by OpenCSV)

## Files That Must Be Modified

When adding a new JAR library, the following files must be updated:

### `Makefile`

**Purpose**: Defines JAR version detection and lists

**Required Changes**:

- Add version detection function call
- Add JAR to either `ECUXPLOT_JARS` or `COMMON_JARS`

**Example**:

```makefile
# Add version detection
NEWLIB_VER := $(call jar_version,newlib)

# Add to appropriate JAR list
ECUXPLOT_JARS := \
    jcommon-$(JCOMMON_VER).jar \
    jfreechart-$(JFREECHART_VER).jar \
    jspline.jar \
    flanagan.jar \
    slf4j-api-$(SLF4J_API_VER).jar \
    logback-classic-$(LOGBACK_CLASSIC_VER).jar \
    logback-core-$(LOGBACK_CORE_VER).jar \
    newlib-$(NEWLIB_VER).jar
```

### `build/build.properties` (Auto-generated)

**Purpose**: Contains resolved JAR names with versions

**Required Changes**: None (auto-generated from Makefile)

**Note**: This file is automatically generated from the Makefile variables, so no manual changes are needed.

### `subbuild.xml`

**Purpose**: Defines Ant classpath references

**Required Changes**: None (uses variables from build.properties)

**Note**: The Ant build file references `${ECUXPLOT_JARS}` and `${COMMON_JARS}` variables, so it automatically picks up new JARs.

### `scripts/ECUxPlot.nsi`

**Purpose**: Windows installer script that copies JAR files

**Required Changes**:

- Add `File "lib\newlib-${NEWLIB_VER}.jar"` line

**Example**:

```nsis
SetOutPath "$INSTDIR\lib"
File "lib\jcommon-${JCOMMON_VER}.jar"
File "lib\jfreechart-${JFREECHART_VER}.jar"
File "lib\opencsv-${OPENCSV_VER}.jar"
File "lib\commons-cli-${COMMONS_CLI_VER}.jar"
File "lib\commons-lang3-${COMMONS_LANG3_VER}.jar"
File "lib\slf4j-api-${SLF4J_API_VER}.jar"
File "lib\logback-classic-${LOGBACK_CLASSIC_VER}.jar"
File "lib\logback-core-${LOGBACK_CORE_VER}.jar"
File "lib\jspline.jar"
File "lib\flanagan.jar"
File "lib\newlib-${NEWLIB_VER}.jar"
```

### `scripts/installer.mk`

**Purpose**: Archive creation script

**Required Changes**: None (uses `$(JARS)` variable from Makefile)

**Note**: This file uses the `$(JARS)` variable which is automatically built from `ECUXPLOT_JARS` and `COMMON_JARS`.

### `scripts/sanity-check.sh`

**Purpose**: Build verification script

**Required Changes**: None (reads from build.properties)

**Note**: The sanity check script reads JAR lists from `build/build.properties`, so it automatically validates new JARs.

### `src/org/nyet/util/Version.java.template`

**Purpose**: Generates version information displayed in the About window

**Required Changes**:

- Add version constant for new JAR (only if JAR has version in filename)
- Add JAR to version display list (only if JAR has version in filename)

**Example**:

```java
public static final String NewLib = "%NEWLIB_VER";

public Version () {
    this.add("ECUxPlot " + Version.ECUxPlot);
    this.add("JFreeChart " + Version.JFreeChart);
    this.add("JCommon " + Version.JCommon);
    this.add("OpenCSV " + Version.OpenCSV);
    this.add("commons-cli " + Version.CommonsCLI);
    this.add("commons-lang3 " + Version.CommonsLang3);
    this.add("newlib " + Version.NewLib);  // Add new JAR here
    this.add("Java compiler " + Version.JavacMajor);
    this.add("Java runtime "+ System.getProperty("java.version"));
}
```

**Note**: This template file is processed by the build system to generate `Version.java`, which displays JAR versions in the About dialog. **Only include JARs that have version numbers in their filenames** (e.g., `newlib-1.2.3.jar`). JARs without versions (e.g., `jspline.jar`, `flanagan.jar`) should not be added to the About window.

## Automation Opportunities

The current system could be improved with automation:

### Automatic JAR Detection

Create a script that scans the `lib/` directory and automatically generates the Makefile variables.

### Template-Based Generation

Use templates to generate installer scripts and other JAR references automatically.

### Build System Integration

Integrate JAR management into the build process to reduce manual steps.

### Validation Scripts

Create scripts to validate that all JAR references are consistent across all files.

## Future Improvements

As mentioned in [Issue #61](https://github.com/nyetwurk/ecuxplot/issues/61), the goal is to automate this process where possible and document the remaining manual steps. Potential improvements include:

- Automatic JAR discovery and version detection
- Template-based file generation
- Build system integration
- Validation and consistency checking
- Documentation generation

This would significantly reduce the manual effort required to add new JAR dependencies and reduce the chance of errors.

## Quick Reference Checklist

### Files to Modify When Adding a JAR

#### Checklist: `Makefile`

- [ ] Add version detection: `NEWLIB_VER := $(call jar_version,newlib)`
- [ ] Add JAR to `ECUXPLOT_JARS` or `COMMON_JARS` list
- [ ] Ensure JAR filename includes version (e.g., `newlib-1.2.3.jar`)

#### Checklist: `scripts/ECUxPlot.nsi`

- [ ] Add `File "lib\newlib-${NEWLIB_VER}.jar"` line
- [ ] Place in correct section (after other JAR file declarations)

#### `lib/` directory

- [ ] Place JAR file with version in filename
- [ ] Ensure file permissions are readable
- [ ] Verify JAR is not corrupted

#### Checklist: `src/org/nyet/util/Version.java.template`

- [ ] Add version constant: `public static final String NewLib = "%NEWLIB_VER";` (only if JAR has version)
- [ ] Add JAR to version display list in `Version()` constructor (only if JAR has version)

### Files That Update Automatically

- [ ] `build/build.properties` - Generated from Makefile
- [ ] `subbuild.xml` - Uses variables from build.properties
- [ ] `scripts/installer.mk` - Uses `$(JARS)` variable
- [ ] `scripts/sanity-check.sh` - Reads from build.properties

### Build Verification Steps

- [ ] Run `make clean && make all`
- [ ] Test runtime: `make run` (if applicable)
- [ ] Build Windows installer and verify JAR inclusion
- [ ] Run `scripts/sanity-check.sh`
- [ ] Test on target platform(s)
- [ ] **Verify About window**: Check that JAR appears in Help â†’ About (if JAR has version)
